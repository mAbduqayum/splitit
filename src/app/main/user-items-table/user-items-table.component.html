<div class="user-items-table">
	<div class="header-controls">
		<h2>Bill Calculator</h2>
		<button appBtn="danger" (click)="clearAllData()" class="clear-button">
			Clear All Data
		</button>
	</div>

	<!-- New Modal Component -->
	@if (modalType()) {
		<app-user-item-form-modal
			[modalType]="modalType()!"
			[modalData]="modalData()"
			[isVisible]="isModalVisible"
			(userSubmitted)="onUserSubmitted($event)"
			(itemSubmitted)="onItemSubmitted($event)"
			(closed)="closeModal()"
		/>
	}

	<div class="table-container">
		<table>
			<thead>
				<tr>
					<th class="corner-header">
						<div class="corner-content">
                            <div class="items-section" (click)="showAddItemForm()">
                                <span class="items-label">Items</span>
                            </div>
							<div class="users-section" (click)="showAddUserForm()">
								<span class="users-label">Users</span>
							</div>
						</div>
					</th>
					@for (item of items(); track item.id) {
						<th class="item-header" [class.quantity-warning]="hasQuantityMismatch(item.id)">
							<div class="item-info">
								<span class="item-name" (dblclick)="startEditItem(item.id, item.name, item.quantity, item.price)">{{ item.name }}</span>
								<span class="item-price">${{ item.price.toFixed(2) }}</span>
								<div class="item-actions">
									<button 
										appBtn="danger" 
										(click)="removeItem(item.id)"
										title="Remove item"
									>
										✕
									</button>
								</div>
							</div>
						</th>
					}
					@if (items().length === 0) {
						<th class="empty-items-header">
							<div class="empty-message">Click "Items" to add items</div>
						</th>
					}
					<th class="subtotal-header">Subtotal</th>
					<th class="tip-header">
						@if (editingTipPercentage()) {
							<div class="edit-tip-form">
								Tip (
								<input 
									type="number" 
									[(ngModel)]="tempTipPercentage"
									(ngModelChange)="updateTipPercentage()"
									(blur)="stopEditTip()"
									(keyup.escape)="stopEditTip()"
									(keyup.enter)="stopEditTip()"
									min="0"
									max="100"
									step="1"
									class="edit-tip-input"
								/>%)
							</div>
						} @else {
							<div class="tip-display" (click)="startEditTip()" (dblclick)="startEditTip()">
								Tip ({{ tipPercentage() }}%)
							</div>
						}
					</th>
					<th class="tax-header">
						@if (editingTaxPercentage()) {
							<div class="edit-tax-form">
								Tax (
								<input 
									type="number" 
									[(ngModel)]="tempTaxPercentage"
									(ngModelChange)="updateTaxPercentage()"
									(blur)="stopEditTax()"
									(keyup.escape)="stopEditTax()"
									(keyup.enter)="stopEditTax()"
									min="0"
									max="100"
									step="1"
									class="edit-tax-input"
								/>%)
							</div>
						} @else {
							<div class="tax-display" (click)="startEditTax()" (dblclick)="startEditTax()">
								Tax ({{ taxPercentage() }}%)
							</div>
						}
					</th>
					<th class="total-header">Total</th>
				</tr>
			</thead>
			<tbody>
				@for (user of users(); track user.id) {
					<tr>
						<td class="user-cell">
							<div class="user-display">
								<span class="user-name" (dblclick)="startEditUser(user.id, user.name)">{{ user.name }}</span>
								<div class="user-actions">
									<button 
										appBtn="danger" 
										(click)="removeUser(user.id)"
										title="Remove user"
									>
										✕
									</button>
								</div>
							</div>
						</td>
						@for (item of items(); track item.id) {
							<td class="quantity-cell">
								@if (isEditing(user.id, item.id)) {
									<input
										type="number"
										[(ngModel)]="editingQuantity"
										(ngModelChange)="updateQuantity(user.id, item.id)"
										(blur)="stopEdit()"
										(keyup.escape)="stopEdit()"
										(keyup.enter)="stopEdit()"
										min="0"
										step="1"
										class="quantity-input"
									/>
								} @else {
									<span 
										class="quantity-display"
										(click)="startEdit(user.id, item.id, getQuantity(user.id, item.id))"
										(dblclick)="startEdit(user.id, item.id, getQuantity(user.id, item.id))"
									>
										{{ getQuantity(user.id, item.id) || '-' }}
									</span>
								}
							</td>
						}
						@if (items().length === 0) {
							<td class="empty-items-cell">-</td>
						}
						<td class="subtotal-cell">
							@if (getUserBill(user.id) > 0) {
								<strong>${{ getUserBill(user.id).toFixed(2) }}</strong>
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="tip-cell">
							@if (getUserBill(user.id) > 0) {
								${{ getUserTip(user.id).toFixed(2) }}
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="tax-cell">
							@if (getUserBill(user.id) > 0) {
								${{ getUserTax(user.id).toFixed(2) }}
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="total-cell">
							@if (getUserBill(user.id) > 0) {
								<strong>${{ getUserTotal(user.id).toFixed(2) }}</strong>
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
					</tr>
				}
				@if (users().length === 0) {
					<tr>
						<td class="empty-users-cell">
							<div class="empty-message">Click "Users" to add users</div>
						</td>
						@for (item of items(); track item.id) {
							<td class="empty-quantity-cell">-</td>
						}
						@if (items().length === 0) {
							<td class="empty-items-cell">-</td>
						}
						<td class="empty-subtotal-cell">$0.00</td>
						<td class="empty-tip-cell">$0.00</td>
						<td class="empty-tax-cell">$0.00</td>
						<td class="empty-total-cell">$0.00</td>
					</tr>
				}
			</tbody>
			<tfoot>
				<tr class="total-row">
					<td class="total-label">Grand Total:</td>
					@for (item of items(); track item.id) {
						<td></td>
					}
					@if (items().length === 0) {
						<td></td>
					}
					<td class="grand-subtotal">
						<strong>${{ getGrandTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-tip">
						<strong>${{ getGrandTipTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-tax">
						<strong>${{ getGrandTaxTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-total">
						<strong>${{ getFinalGrandTotal().toFixed(2) }}</strong>
					</td>
				</tr>
			</tfoot>
		</table>
	</div>
</div>
