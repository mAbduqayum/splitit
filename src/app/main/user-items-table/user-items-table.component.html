<div class="user-items-table">
	<div class="header-controls">
		<h2>Bill Calculator</h2>
		<button appBtn="danger" (click)="clearAllData()" class="clear-button">
			Clear All Data
		</button>
	</div>

	@if (showingAddUserForm()) {
		<div class="add-forms-overlay" (click)="hideAddForms()">
			<div class="add-user-modal" (click)="$event.stopPropagation()">
				<div class="modal-header">
					<h3>Add User</h3>
					<button appBtn="secondary" (click)="hideAddForms()">Close</button>
				</div>
				<div class="modal-content">
					<form [formGroup]="userForm" (ngSubmit)="addUser()">
						<input 
							type="text" 
							formControlName="name" 
							placeholder="Enter user name"
							autocomplete="off"
						/>
						<button type="submit" appBtn="primary" [disabled]="userForm.invalid">
							Add User
						</button>
					</form>
				</div>
			</div>
		</div>
	}

	@if (showingAddItemForm()) {
		<div class="add-forms-overlay" (click)="hideAddForms()">
			<div class="add-item-modal" (click)="$event.stopPropagation()">
				<div class="modal-header">
					<h3>Add Item</h3>
					<button appBtn="secondary" (click)="hideAddForms()">Close</button>
				</div>
				<div class="modal-content">
					<form [formGroup]="itemForm" (ngSubmit)="addItem()">
						<input 
							type="text" 
							formControlName="name" 
							placeholder="Item name"
							autocomplete="off"
						/>
						<input 
							type="number" 
							formControlName="quantity" 
							min="1"
						/>
						<input 
							type="number" 
							formControlName="price" 
							min="0"
							step="1"
						/>
						<button type="submit" appBtn="primary" [disabled]="itemForm.invalid">
							Add Item
						</button>
					</form>
				</div>
			</div>
		</div>
	}

	<div class="table-container">
		<table>
			<thead>
				<tr>
					<th class="corner-header">
						<div class="corner-content">
							<div class="users-section" (click)="showAddUserForm()">
								<span class="users-label">Users</span>
							</div>
							<div class="items-section" (click)="showAddItemForm()">
								<span class="items-label">Items</span>
							</div>
						</div>
					</th>
					@for (item of items(); track item.id) {
						<th class="item-header" [class.quantity-warning]="hasQuantityMismatch(item.id)">
							@if (editingItemId() === item.id) {
								<div class="edit-item-form">
									<input 
										type="text" 
										[(ngModel)]="editingItemName"
										(ngModelChange)="updateItemName(item.id)"
										(blur)="stopEditItem()"
										(keyup.escape)="stopEditItem()"
										(keyup.enter)="stopEditItem()"
										class="edit-item-name-input"
										placeholder="Item name"
									/>
									<input 
										type="number" 
										[(ngModel)]="editingItemQuantity"
										(ngModelChange)="updateItemQuantity(item.id)"
										(blur)="stopEditItem()"
										(keyup.escape)="stopEditItem()"
										(keyup.enter)="stopEditItem()"
										min="1"
										class="edit-item-quantity-input"
									/>
									<input 
										type="number" 
										[(ngModel)]="editingItemPrice"
										(ngModelChange)="updateItemPrice(item.id)"
										(blur)="stopEditItem()"
										(keyup.escape)="stopEditItem()"
										(keyup.enter)="stopEditItem()"
										min="0"
										step="1"
										class="edit-item-price-input"
									/>
								</div>
							} @else {
								<div class="item-info">
									<span class="item-name" (dblclick)="startEditItem(item.id, item.name, item.quantity, item.price)">{{ item.name }}</span>
									<span class="item-price">${{ item.price.toFixed(2) }}</span>
									<div class="item-actions">
										<button 
											appBtn="info" 
											(click)="startEditItem(item.id, item.name, item.quantity, item.price)"
										>
											Edit
										</button>
										<button 
											appBtn="danger" 
											(click)="removeItem(item.id)"
										>
											Remove
										</button>
									</div>
								</div>
							}
						</th>
					}
					@if (items().length === 0) {
						<th class="empty-items-header">
							<div class="empty-message">Click "Items" to add items</div>
						</th>
					}
					<th class="subtotal-header">Subtotal</th>
					<th class="tip-header">
						Tip ({{ tipPercentage() }}%)
						<div class="tip-controls">
							<input 
								type="number" 
								[(ngModel)]="tipPercentage"
								min="0"
								max="100"
								step="1"
								class="percentage-input"
							/>%
						</div>
					</th>
					<th class="tax-header">
						Tax ({{ taxPercentage() }}%)
						<div class="tax-controls">
							<input 
								type="number" 
								[(ngModel)]="taxPercentage"
								min="0"
								max="100"
								step="1"
								class="percentage-input"
							/>%
						</div>
					</th>
					<th class="total-header">Total</th>
				</tr>
			</thead>
			<tbody>
				@for (user of users(); track user.id) {
					<tr>
						<td class="user-cell">
							@if (editingUserId() === user.id) {
								<div class="edit-user-form">
									<input 
										type="text" 
										[(ngModel)]="editingUserName"
										(ngModelChange)="updateUser(user.id)"
										(blur)="stopEditUser()"
										(keyup.escape)="stopEditUser()"
										(keyup.enter)="stopEditUser()"
										class="edit-user-input"
										placeholder="Enter user name"
									/>
								</div>
							} @else {
								<div class="user-display">
									<span class="user-name" (dblclick)="startEditUser(user.id, user.name)">{{ user.name }}</span>
									<div class="user-actions">
										<button 
											appBtn="info" 
											(click)="startEditUser(user.id, user.name)"
										>
											Edit
										</button>
										<button 
											appBtn="danger" 
											(click)="removeUser(user.id)"
										>
											Remove
										</button>
									</div>
								</div>
							}
						</td>
						@for (item of items(); track item.id) {
							<td class="quantity-cell">
								@if (isEditing(user.id, item.id)) {
									<input
										type="number"
										[(ngModel)]="editingQuantity"
										(ngModelChange)="updateQuantity(user.id, item.id)"
										(blur)="stopEdit()"
										(keyup.escape)="stopEdit()"
										(keyup.enter)="stopEdit()"
										min="0"
										step="0.1"
										class="quantity-input"
									/>
								} @else {
									<span 
										class="quantity-display"
										(click)="startEdit(user.id, item.id, getQuantity(user.id, item.id))"
										(dblclick)="startEdit(user.id, item.id, getQuantity(user.id, item.id))"
									>
										{{ getQuantity(user.id, item.id) || '-' }}
									</span>
								}
							</td>
						}
						@if (items().length === 0) {
							<td class="empty-items-cell">-</td>
						}
						<td class="subtotal-cell">
							@if (getUserBill(user.id) > 0) {
								<strong>${{ getUserBill(user.id).toFixed(2) }}</strong>
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="tip-cell">
							@if (getUserBill(user.id) > 0) {
								${{ getUserTip(user.id).toFixed(2) }}
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="tax-cell">
							@if (getUserBill(user.id) > 0) {
								${{ getUserTax(user.id).toFixed(2) }}
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
						<td class="total-cell">
							@if (getUserBill(user.id) > 0) {
								<strong>${{ getUserTotal(user.id).toFixed(2) }}</strong>
							} @else {
								<span class="no-bill">$0.00</span>
							}
						</td>
					</tr>
				}
				@if (users().length === 0) {
					<tr>
						<td class="empty-users-cell">
							<div class="empty-message">Click "Users" to add users</div>
						</td>
						@for (item of items(); track item.id) {
							<td class="empty-quantity-cell">-</td>
						}
						@if (items().length === 0) {
							<td class="empty-items-cell">-</td>
						}
						<td class="empty-subtotal-cell">$0.00</td>
						<td class="empty-tip-cell">$0.00</td>
						<td class="empty-tax-cell">$0.00</td>
						<td class="empty-total-cell">$0.00</td>
					</tr>
				}
			</tbody>
			<tfoot>
				<tr class="total-row">
					<td class="total-label">Grand Total:</td>
					@for (item of items(); track item.id) {
						<td></td>
					}
					@if (items().length === 0) {
						<td></td>
					}
					<td class="grand-subtotal">
						<strong>${{ getGrandTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-tip">
						<strong>${{ getGrandTipTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-tax">
						<strong>${{ getGrandTaxTotal().toFixed(2) }}</strong>
					</td>
					<td class="grand-total">
						<strong>${{ getFinalGrandTotal().toFixed(2) }}</strong>
					</td>
				</tr>
			</tfoot>
		</table>
	</div>
</div>
